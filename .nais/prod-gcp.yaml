apiVersion: nais.io/v1alpha1
kind: Application
metadata:
  name: su-se-bakover
  namespace: supstonad
  labels:
    team: supstonad
spec:
  gcp:
    bigQueryDatasets:
      - name: avslagsvedtak
        permission: READWRITE
      - name: saksstatistikk
        permission: READWRITE
      - name: soknad
        permission: READWRITE
      - name: statistikk
        permission: READWRITE
    sqlInstances:
      - type: POSTGRES_17
        tier: db-custom-1-3840
        collation: nb_NO.UTF8
        diskAutoresize: true
        diskSize: 20
        diskType: SSD
        highAvailability: true
        pointInTimeRecovery: true
        retainedBackups: 21
        autoBackupHour: 3
        maintenance:
          day: 7
          hour: 2
        cascadingDelete: false
        name: supstonad-db-15-prod
        databases:
          - name: supstonad
            envVarPrefix: DB
        flags:
          - name: max_connections
            value: "100"
          - name: "cloudsql.enable_pgaudit"
            value: "on"
          - name: "pgaudit.log"
            value: "write,ddl,role"
          - name: "pgaudit.log_parameter"
            value: "on"
  observability:
    autoInstrumentation:
      enabled: true
      runtime: java
    logging:
      destinations:
        - id: elastic
        - id: loki
        - id: team_logs
  azure:
    application:
      enabled: true
      tenant: nav.no
      claims:
        extra:
          - "NAVident"
        groups:
          - id: "b64af061-f7c4-4d05-907f-b457e23da339" # 0000-GA-SU-UFOR-ATTESTANT
          - id: "654d28c0-b02b-4c50-86a0-896cf64e79f0" # 0000-GA-SU-UFOR-SAKSBEHANDLER
          - id: "4b1ccffd-b1e1-41a7-9f3a-d4acb6d53b05" # 0000-GA-SU-UFOR-VEILEDER
          - id: "6c5cb261-d91e-40a8-a925-458bfdd9d033" # 0000-GA-SU-UFOR-DRIFT
  accessPolicy:
    inbound:
      rules:
        - application: "su-se-framover"
          namespace: "supstonad"
          cluster: "prod-gcp"
        - application: "frikorttjenester"
          namespace: "teamfrikort"
          cluster: "prod-fss"
          permissions:
            roles:
              - frikort
    outbound:
      rules:
        - application: pensjon-pen
          namespace: pensjondeployer
          cluster: prod-fss
        - application: supstonad-proxy
          namespace: supstonad
          cluster: prod-fss
        - application: api-intern
          namespace: aap
          cluster: prod-gcp
        - application: skjermede-personer-pip # namespace hører til denne. Ikke legg til ny app i mellom.
          namespace: nom
          cluster: prod-gcp
        - application: su-pdfgen
          namespace: supstonad
          cluster: prod-gcp
        - application: logging
          namespace: nais-system
        - application: kabal-api
          namespace: klage
          cluster: prod-gcp
        - application: digdir-krr-proxy
          namespace: team-rocket
          cluster: prod-gcp
        - application: kodeverk-api
          namespace: team-rocket
          cluster: prod-gcp
      external:
        - host: pensjon-pen.prod-fss-pub.nais.io
        - host: supstonad-proxy.prod-fss-pub.nais.io
        - host: pdl-api.prod-fss-pub.nais.io
        - host: saf.prod-fss-pub.nais.io
        - host: inst2.prod-fss-pub.nais.io
        - host: dokdistfordeling.prod-fss-pub.nais.io
        - host: oppgave.prod-fss-pub.nais.io
        - host: sigrun.prod-fss-pub.nais.io
        - host: kodeverk-api.nav.no
        - host: dokarkiv.prod-fss-pub.nais.io
        - host: mpls02.adeo.no
          ports:
            - port: 1414
  image: {{ image }}
  liveness:
    path: /isalive
    initialDelay: 25
    timeout: 10
  readiness:
    path: /isready
    initialDelay: 25
    timeout: 10
  replicas:
    min: 1
    max: 2
  resources:
    limits:
      memory: 4Gi
    requests:
      memory: 2Gi
      cpu: 1000m
  ingresses:
    - https://su-se-bakover-gcp.intern.nav.no # bytt til https://su-se-bakover.intern.nav.no etter migrering?
    - https://su-se-bakover.intern.nav.no # brukes av frikort
  prometheus:
    enabled: true
    path: /metrics
  leaderElection: true
  kafka:
    pool: nav-prod
  envFrom:
    #Denne inneholder servicebruker passord og brukernavn da vault ikke støttes i GCP - serviceuser og serviceuserpw
    - secret: supstonad-servicebruker
  env:
    - name: AAP_API_INTERN_URL
      value: "http://api-intern.aap"
    - name: AAP_API_INTERN_CLIENT_ID
      value: "api://prod-gcp.aap.api-intern"
    - name: PESYS_URL
      value: "https://pensjon-pen.prod-fss-pub.nais.io/pen/api/"
    - name: PESYS_CLIENT_ID
      value: "api://prod-fss.pensjondeployer.pensjon-pen"
    - name: SUPSTONAD_PROXY_URL
      value: "https://supstonad-proxy.prod-fss-pub.nais.io"
    - name: SUPSTONAD_PROXY_CLIENT_ID
      value: "api://prod-fss.supstonad.supstonad-proxy"
    - name: AZURE_GROUP_ATTESTANT
      value: "b64af061-f7c4-4d05-907f-b457e23da339"
    - name: AZURE_GROUP_VEILEDER
      value: "4b1ccffd-b1e1-41a7-9f3a-d4acb6d53b05"
    - name: AZURE_GROUP_SAKSBEHANDLER
      value: "654d28c0-b02b-4c50-86a0-896cf64e79f0"
    - name: AZURE_GROUP_DRIFT
      value: "6c5cb261-d91e-40a8-a925-458bfdd9d033"
    - name: DATABASE_NAME
      value: "supstonad-db-15-prod"
    - name: PDFGEN_URL
      value: "http://su-pdfgen"
    - name: DOKARKIV_URL
      value: "https://dokarkiv.prod-fss-pub.nais.io"
    - name: DOKARKIV_CLIENT_ID
      value: "api://prod-fss.teamdokumenthandtering.dokarkiv"
    - name: OPPGAVE_URL
      value: "https://oppgave.prod-fss-pub.nais.io"
    - name: OPPGAVE_CLIENT_ID
      value: "api://prod-fss.oppgavehandtering.oppgave"
    - name: DOKDIST_URL
      value: "https://dokdistfordeling.prod-fss-pub.nais.io"
    - name: DOKDIST_CLIENT_ID
      value: "api://prod-fss.teamdokumenthandtering.dokdistfordeling"
    - name: SKJERMING_URL
      value: "http://skjermede-personer-pip.nom"
    - name: SKJERMING_CLIENT_ID
      value: "api://prod-gcp.nom.skjermede-personer-pip"
    - name: MQ_QUEUE_MANAGER
      value: "MPLS02"
    - name: MQ_PORT
      value: "1414"
    - name: MQ_HOSTNAME
      value: "mpls02.adeo.no"
    - name: MQ_CHANNEL
      value: "P_SU_SE_BAKOVER"
    - name: MQ_SEND_QUEUE_UTBETALING
      value: "QA.P231.OB04_OPPDRAG_XML"
    - name: MQ_REPLY_TO
      value: "QA.P_SU_SE_BAKOVER.OPPDRAG_KVITTERING"
    - name: MQ_SEND_QUEUE_AVSTEMMING
      value: "queue:///QA.P234.OB29_AVSTEMMING_XML?targetClient=1"
    - name: PDL_URL
      value: "https://pdl-api.prod-fss-pub.nais.io"
    - name: PDL_CLIENT_ID
      value: "api://prod-fss.pdl.pdl-api"
    - name: KABAL_URL
      value: "http://kabal-api.klage"
    - name: KABAL_CLIENT_ID
      value: "api://prod-gcp.klage.kabal-api"
    - name: SAF_URL
      value: "https://saf.prod-fss-pub.nais.io"
    - name: SAF_CLIENT_ID
      value: "api://prod-fss.teamdokumenthandtering.saf"
    - name: MQ_TILBAKEKREVING_MOTTAK
      value: "QA.P_SU_SE_BAKOVER.OPPDRAG_KRAVGRUNNLAG"
    - name: SKATTEETATEN_URL
      value: "https://sigrun.prod-fss-pub.nais.io"
    - name: SKATT_CLIENT_ID
      value: "api://prod-fss.team-inntekt.sigrun"
    - name: KRR_URL
      value: "http://digdir-krr-proxy.team-rocket"
    - name: KRR_APP_ID
      value: "api://prod-gcp.team-rocket.digdir-krr-proxy"
    - name: INSTITUSJONSOPPHOLD_TOPIC
      value: "team-rocket.institusjon-opphold-hendelser"
    - name: KODEVERK_URL
      value: "https://kodeverk-api.nav.no"
    - name: KODEVERK_CLIENT_ID
      value: "api://prod-gcp.team-rocket.kodeverk-api"
